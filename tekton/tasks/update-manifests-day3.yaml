apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: update-manifests-day3
spec:
  params:
    - name: manifest-path    # e.g. k8s/deployment.yaml
      type: string
    - name: namespace        # studentXX
      type: string
    - name: image-tag        # commit SHA or build ID
      type: string
    - name: git-repo-url     # GitHub repo URL
      type: string
  workspaces:
    - name: source           # repo checked-out by the clone task
  steps:
  - name: retag-and-update
    image: bitnami/kubectl:latest
    workingDir: $(workspaces.source.path)
    env:
      - name: GITHUB_TOKEN
        valueFrom:
          secretKeyRef:
            name: git-credentials
            key: token
    script: |
      #!/bin/bash
      set -euo pipefail
      
      COMMIT_SHA="$(params.image-tag)"
      NAMESPACE="$(params.namespace)"
      SOURCE_IMAGE="image-registry.openshift-image-registry.svc:5000/${NAMESPACE}/java-webapp:latest"
      TARGET_IMAGE="image-registry.openshift-image-registry.svc:5000/${NAMESPACE}/java-webapp:${COMMIT_SHA}"
      
      echo "ğŸ” Checking if source image exists: ${SOURCE_IMAGE}"
      if ! oc get istag java-webapp:latest -n ${NAMESPACE} &>/dev/null; then
        echo "âŒ Source image java-webapp:latest not found in ${NAMESPACE}"
        echo "   This usually means the Shipwright build hasn't completed successfully."
        echo "   Please check the BuildRun status and logs."
        exit 1
      fi
      
      echo "âœ… Source image found, proceeding with retag"
      echo "ğŸ·ï¸  Retagging image: latest â†’ ${COMMIT_SHA}"
      oc tag ${SOURCE_IMAGE} ${TARGET_IMAGE}
      
      echo "ğŸ“ Updating $(params.manifest-path) with new image tag"
      # Update deployment.yaml with full image path including new tag
      yq e ".spec.template.spec.containers[0].image = \"${TARGET_IMAGE}\"" -i "$(params.manifest-path)"
      
      echo "âœ… Updated deployment manifest:"
      yq e '.spec.template.spec.containers[0].image' "$(params.manifest-path)"
      
      echo "ğŸ“¤ Committing and pushing changes"
      git config --global user.name "Tekton Pipeline"
      git config --global user.email "tekton@bootcamp.local"
      
      git add "$(params.manifest-path)"
      
      # Check if there are changes to commit
      if git diff --staged --quiet; then
        echo "â„¹ï¸  No changes to commit - manifest already up to date"
      else
        echo "ğŸ“ Committing changes..."
        git commit -m "Update image tag to ${COMMIT_SHA}"
        
        echo "ğŸš€ Pushing to branch ${NAMESPACE}..."
        # Extract repo info for authenticated push
        REPO_URL="$(params.git-repo-url)"
        REPO_WITH_TOKEN=$(echo $REPO_URL | sed "s|https://|https://$GITHUB_TOKEN@|")
        
        git push $REPO_WITH_TOKEN HEAD:${NAMESPACE}
        echo "âœ… Successfully pushed changes to trigger ArgoCD sync!"
        echo "ğŸ¯ ArgoCD will now detect the change and deploy image: ${TARGET_IMAGE}"
      fi
